# Falak Mail Relay

A secure and reliable mail relay service built with Next.js, featuring automatic failover between Brevo (primary) and NotificationAPI (fallback). Powered by Convex for serverless database operations.

## Features

- üîÑ **Dual Provider Support**: Primary delivery via Brevo with automatic NotificationAPI fallback
- üìä **Comprehensive Logging**: Every email logged with full metadata (sender, reply-to, content info, provider)
- ‚öôÔ∏è **Admin Dashboard**: Manage API keys, view logs, and monitor system status
- üîê **Secure Authentication**: 
  - Site key-based admin login
  - API keys hashed with SHA-256 (never stored in plaintext)
  - Bearer token authentication for API requests
- üé® **Modern UI**: Responsive design with dark mode support using Tailwind CSS
- üì± **Mobile Friendly**: Works seamlessly on all devices
- ‚òÅÔ∏è **Serverless**: Built on Convex for scalable database operations
- üöÄ **Vercel Ready**: Deploy directly to Vercel without native module issues

## Tech Stack

- **Framework**: Next.js 16.1.4 with App Router
- **Language**: TypeScript (strict mode)
- **Styling**: Tailwind CSS v4 with FalakSans font
- **Database**: Convex (serverless backend)
- **Email Providers**: Brevo (primary), NotificationAPI (fallback)
- **Authentication**: Session-based + Bearer tokens
- **Deployment**: Vercel-ready

## Getting Started

### Prerequisites

- Node.js 18+ or Bun
- NotificationAPI account
- Brevo account

### Installation

1. Clone the repository:
```bash
git clone https://github.com/Falakme/mail-relay.git
cd mail-relay
```

2. Install dependencies:
```bash
bun install
# or
npm install
```

3. Set up Convex:
```bash
bunx convex dev
# Follow prompts to create a Convex project
```

4. Create environment file:
```bash
cp .env.example .env
```

5. Configure your environment variables in `.env`:
```env
# Admin Authentication
SITE_KEY=your-secure-site-key

# Email Provider Credentials
NOTIFICATIONAPI_CLIENT_ID=your-client-id
NOTIFICATIONAPI_CLIENT_SECRET=your-client-secret
BREVO_API_KEY=your-brevo-api-key

# Optional: Default sender email
DEFAULT_FROM_EMAIL=noreply@alerts.falak.me

# Convex Configuration (generated by convex dev)
CONVEX_DEPLOYMENT=dev:your-deployment-id
NEXT_PUBLIC_CONVEX_URL=https://your-deployment-id.convex.cloud
```

6. Start the development server:
```bash
bun dev
# or
npm run dev
```

7. Open [http://localhost:3000](http://localhost:3000)

## API Usage

### Send Email

```bash
POST /api/send-mail
Content-Type: application/json
Authorization: Bearer YOUR_API_KEY

{
  "to": "recipient@example.com",
  "subject": "Email Subject",
  "body": "Plain text body",
  "html": "<p>Optional HTML body</p>",
  "from": "sender@example.com",
  "senderName": "Sender Name",
  "replyTo": "reply@example.com"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Email sent successfully via Brevo",
  "provider": "brevo",
  "logId": "uuid"
}
```

### Check Status

```bash
GET /api/status
```

**Response:**
```json
{
  "success": true,
  "status": "healthy",
  "totalEmailsSent": 42,
  "rateLimits": {
    "notificationapi": { "isLimited": false, "backoffUntil": 0 },
    "brevo": { "isLimited": false, "backoffUntil": 0 }
  },
  "timestamp": "2026-01-26T10:00:00.000Z"
}
```

## Admin Panel

Access the admin panel at `/` and login with your `SITE_KEY`.

### Features:
- **Email Logs**: View all sent emails with status, provider, and full request metadata
- **API Keys**: Generate, manage, and monitor API keys (hashed with SHA-256)
- **System Status**: Monitor health, total emails, and rate limit status
- **Test Email**: Send test emails to verify your setup

### API Key Security:
- Keys are hashed with SHA-256 before storage
- Only the full key is shown once on creation
- Plaintext keys are never stored or displayed again
- Each API key tracks usage count and last used timestamp

## Project Structure

```
mail-relay/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ send-mail/route.ts    # Email sending endpoint (Brevo primary, NotificationAPI fallback)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/route.ts          # Authentication endpoint (login/logout/check)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logs/route.ts          # Email logs endpoint (Convex backed)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api-keys/route.ts      # API keys management (CRUD with hashing)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ status/route.ts        # System status endpoint
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                   # Admin dashboard with all features
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx                 # Root layout
‚îÇ   ‚îî‚îÄ‚îÄ globals.css                # Global styles
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ types.ts                   # TypeScript types
‚îÇ   ‚îú‚îÄ‚îÄ email-service.ts           # Email sending logic with dual providers
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                    # Authentication utilities (cookie & bearer token)
‚îÇ   ‚îî‚îÄ‚îÄ crypto-utils.ts            # API key hashing utilities
‚îú‚îÄ‚îÄ convex/
‚îÇ   ‚îú‚îÄ‚îÄ schema.ts                  # Database schema (emailLogs, apiKeys tables)
‚îÇ   ‚îú‚îÄ‚îÄ emailLogs.ts               # Email log queries and mutations
‚îÇ   ‚îú‚îÄ‚îÄ apiKeys.ts                 # API key queries and mutations (with hashing)
‚îÇ   ‚îî‚îÄ‚îÄ _generated/                # Convex generated types
‚îî‚îÄ‚îÄ public/                        # Static assets
```

## Convex Setup

Convex is used for serverless database operations. It's already configured in the project:

1. During `bunx convex dev`, you'll create a Convex project
2. The project automatically creates two tables:
   - `emailLogs`: Stores all sent emails with metadata
   - `apiKeys`: Stores hashed API keys with usage tracking
3. All data syncs to your Convex deployment in real-time

**Data Models:**
- **Email Logs**: messageId, to, subject, status, provider, timestamp, metadata, error
- **API Keys**: name, key (hashed), isActive, createdAt, lastUsed, usageCount

## NotificationAPI Setup

1. Create an account at [NotificationAPI](https://www.notificationapi.com/)
2. Create a new notification template named `email_relay`
3. Configure the template with merge tags: `{{subject}}`, `{{body}}`, `{{html}}`
4. Copy your Client ID and Client Secret to your `.env`

## Brevo Setup

1. Create an account at [Brevo](https://www.brevo.com/)
2. Go to Settings > SMTP & API > API Keys
3. Generate a new API key
4. Copy the API key to your `.env`

## Deployment

### Vercel (Recommended)

1. Push your code to GitHub
2. Import the project in Vercel
3. Add environment variables in Vercel dashboard:
   - `SITE_KEY`
   - `NOTIFICATIONAPI_CLIENT_ID`
   - `NOTIFICATIONAPI_CLIENT_SECRET`
   - `BREVO_API_KEY`
   - `CONVEX_DEPLOYMENT` (from `convex dev` output)
   - `NEXT_PUBLIC_CONVEX_URL` (from `convex dev` output)
4. Deploy!

**Why Convex + Vercel?**
- Convex eliminates native module issues (no SQLite binary problems)
- Serverless database works perfectly with Vercel's edge functions
- Automatic scaling and backups included
- Real-time sync to your Convex dashboard

### Docker

```dockerfile
FROM oven/bun:1 as base
WORKDIR /app
COPY package.json bun.lock ./
RUN bun install --frozen-lockfile
COPY . .
RUN bun run build
EXPOSE 3000
CMD ["bun", "start"]
```

Make sure to set all environment variables when running the container.

## Security Considerations

- ‚úÖ **API Keys**: Hashed with SHA-256, never stored in plaintext
- ‚úÖ **SITE_KEY**: Store securely and use a strong, random value (128+ bits)
- ‚úÖ **Authentication**: Dual mechanism - httpOnly cookies (same-origin) + Bearer tokens (cross-origin)
- ‚úÖ **CORS Ready**: Supports API calls from different origins via Authorization headers
- ‚úÖ **Logging**: No sensitive data in logs; only usage metadata tracked
- ‚ö†Ô∏è **HTTPS**: Use HTTPS in production (Vercel provides this automatically)
- ‚ö†Ô∏è **Rate Limiting**: Consider adding rate limiting for `/api/send-mail` in production
- ‚ö†Ô∏è **Email Verification**: Sender email addresses must be verified with your email provider

## Brand Colors

- Primary Background: `#0000C0`
- Accent/Highlights: `#000040`
- Font: FalakSans

## License

MIT License - feel free to use this project for your own purposes.

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.
